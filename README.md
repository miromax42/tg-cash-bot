# Telegram bot (ДЗ1) 

[![pipeline status](https://gitlab.ozon.dev/miromaxxs/telegram-bot/badges/master/pipeline.svg)](https://gitlab.ozon.dev/miromaxxs/telegram-bot/-/commits/master) [![coverage report](https://gitlab.ozon.dev/miromaxxs/telegram-bot/badges/master/coverage.svg)](https://gitlab.ozon.dev/miromaxxs/telegram-bot/-/commits/master)

[[_TOC_]]

## ТЗ
### GOHW-1
- Команда добавления новой финансовой "траты". В трате должна присутствовать сумма, категория и дата. Но можете добавить еще поля, если считаете нужным. Придумайте, как оформить команду так, чтобы пользователю было удобно ее использовать.
- Хранение трат в памяти, базы данных пока не используем.
- Команда запроса отчета за последнюю неделю/месяц/год. В отчете должны быть суммы трат по категориям.

### GOHW-2
- Команда переключения бота на конкретную валюту - "/currency"
    1. После ввода команды бот предлагает выбрать интересующую валюту из четырех: USD, CNY, EUR, RUB
    2. При нажатии на нужную валюту переключаем бота на нее - результат получение трат конвертируется в выбранную валюту.
- Храним траты всегда в рублях, конвертацию используем только для отображения, ввода и отчетов
- Особенности
     * При запуске сервиса мы в отдельном потоке запрашиваем курсы валют.
     * Запрос курса валют происходит из любого из открытых источников.
     * Сервис должен завершаться gracefully.
  
### GOHW-3
- [x] Завести PostgreSQL в Docker, резметить таблички и схемы, любые действия с БД проводить только через миграции
- [x] Перенести хранение данных из памяти приложения в базу данных
- [ ] Добавить бюджеты/лимиты: на траты в месяц, при проведении транзакций проверять согласованность данных (превышен ли бюджет и тд)
- [ ] Сгенерировать тестовые данные для таблицы расходов
- [ ] Создать индексы на таблицу расходов, в комментариях к миграции пояснить выбор индексируемых колонок и типа индекса

## Конфигурация
* `TLG_TOKEN` - токен телеграм бота
* `EXCHANGE_TOKEN`- токен для [сервиса получения курсов валют](https://apilayer.com/marketplace/fixer-api)
* `EXCHANGE_BASE_CURRENCY` - код дефолтной валюты (USD, CNY, EUR, RUB)
* `DB_URL` - postgres URL (по-умолчанию `postgres://postgres:postgres@localhost:5432/postgres?sslmode=disable`)

## Выбор библиотек
* `telebot` - мне как бекенд разработчику, гораздо комфортнее с httpServer-подобной семантикой  
* `ent` - просто хороший ORM для golang (по сравнению с gorm, bun более производительный за счет кодогенерации)

## tAPI

### Добавление траты
`/exp <amount> <category>` - добавление траты в `<amount>` у.е. на категорию `<category>`. 
  #### Валидация
  * 0 < `amount` < 100000
  * `category` - любая строка длинны от 1 до 100
  #### Примеры
  * `/exp 12 FUN`
  * `/exp 11.99 rest`
  * `/exp 12.00 ZHkh`
---
### Отчет по тратам
`/all <time_token>` - траты за последнее время=`<time_token>` по кaтегориям
  #### Примеры
  * `/all day` - за последний день
  * `/all year` - за последний год
  * `/all 1m30s` - за последние полторы минуты
---
### Выбор валюты
`/currency` - меню выбора валю из списка поддерживаемых (USD, CNY, EUR, RUB)